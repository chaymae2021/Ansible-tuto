- name: Push Configuration , Load & Commit configuration to Palo Alto Networks equipements
  hosts: ALL
  gather_facts: no

  tasks: 
    - name: Checking ssh connectivity
      connection: local
      wait_for: 
        host: '{{ ansible_host }}'
        port: 22  
        timeout: 5

    - name: Download configuration file from SFTP server
      connection: local
      ansible.builtin.fetch:
        src: '{{ sftp_dir }}/{{ hostname }}.txt'
        dest: '{{ configs_dir }}/{{ hostname }}.txt'
        flat: yes
        username: '{{ sftp_user }}'
        password: '{{ sftp_pass }}'
        host: '{{ sftp_server }}'
        mode: '0644'
        
    - name: Push  configurations on each devices from the {{ configs_dir }} directory
      connection: local
      panos_import:
        validate_certs: no
        ip_address: '{{ ansible_host }}'
        username: '{{ ansible_ssh_user }}'
        password: '{{ ansible_ssh_pass }}'
        file: '{{ configs_dir }}{{ hostname }}.txt'
        category: "configuration"

    - name: Load configurations on each devices
      connection: local
      panos_loadcfg:
        ip_address: '{{ ansible_host }}'
        username: '{{ ansible_ssh_user }}'
        password: '{{ ansible_ssh_pass }}'
        file: '{{ hostname }}.txt'

    - name: Commit configuration on each devices
      connection: local
      panos_commit:
        ip_address: '{{ ansible_host }}'
        username: '{{ ansible_ssh_user }}'
        password: '{{ ansible_ssh_pass }}'
